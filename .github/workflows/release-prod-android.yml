name: Production Android Release (EAS)

on:
  workflow_dispatch:
    inputs:
      git_ref:
        description: 'Git ref (tag/branch/SHA) to build'
        required: false
        default: ''
      mode:
        description: 'promote (submit latest QA artifact) or build (new prod build)'
        required: true
        default: 'promote'
        type: choice
        options:
          - promote
          - build

jobs:
  build-android-prod:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      # Provide Google Play Service Account JSON as a secret
      GOOGLE_SERVICE_ACCOUNT_KEY: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.git_ref || github.ref }}

      - name: Setup Node + PNPM + Install
        uses: ./.github/actions/setup-node-pnpm-install

      - name: Promote latest QA artifact to Production (no rebuild)
        if: inputs.mode == 'promote'
        run: npx --yes eas-cli@latest submit --platform android --latest --non-interactive --profile production

      - name: EAS build & auto-submit (Android Production)
        if: inputs.mode == 'build'
        uses: ./.github/actions/eas-build
        with:
          platform: android
          profile: production
          auto-submit: 'true'
          submit-profile: production
